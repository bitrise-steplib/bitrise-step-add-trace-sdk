format_version: 4
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

app:
  envs:
  - TEST_REPO: https://github.com/bitrise-io/iOS-Sample.git

workflows:
  test:
    envs:
    - BITRISE_PROJECT_PATH: "$BITRISE_SOURCE_DIR/_tmp/iOS-Sample/iOS Sample.xcodeproj"
    - BITRISE_SCHEME: "iOS Sample"
    - APM_COLLECTOR_TOKEN: 951fc805-5bb3-4a36-9c5b-7443b51d7067 #dummy token
    steps:
    - script:
        run_if: .IsCI
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            set -x

            gem install bundler --force
            gem update --system
            bundle update --bundler
    - script:
        title: Run rspec tests
        inputs:
        - content: |-
            #!/bin/bash
            set -e
            set -x

            bundle exec rspec
    - script:
        title: Cleanup _tmp dir
        inputs:
        - content: |-
            #!/bin/bash
            set -e
            set -x

            rm -rf "_tmp"
            mkdir -p "_tmp"
    - change-workdir:
        title: Switch working dir to _tmp
        inputs:
        - path: ./_tmp
        - is_create_path: "true"
    - script:
        inputs:
        - content: |-
            #!/bin/bash
            set -e
            set -x

            git clone $TEST_REPO
    - path::./:
        title: Run step
        inputs:
        - lib_version: "latest"
    - script:
        title: Run blackbox tests
        inputs:
        - content: |-
            #!/bin/bash
            set -e
            set -x

            ruby ./../step_test.rb "$BITRISE_PROJECT_PATH"
    - script:
        run_if: .IsCI
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            set -x

            envman add --key BITRISE_PROJECT_ZIP --value $(dirname "${BITRISE_PROJECT_PATH}")
    - create-zip@0.9.0:
        run_if: .IsCI
        inputs:
        - destination: $BITRISE_DEPLOY_DIR
        - source_path: $BITRISE_PROJECT_ZIP
